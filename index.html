<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ADIS - Learning Styles Assessment</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand-grad: linear-gradient(135deg,#667eea,#764ba2,#f093fb);
    }
    body{
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',sans-serif;
      background: var(--brand-grad);
      min-height:100vh;
    }
    .glass{background:rgba(255,255,255,.92);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.4);box-shadow:0 20px 40px rgba(0,0,0,.12)}
    .btn{transition:.2s}
    .btn:hover{transform:translateY(-1px) scale(1.03)}
    .bar{transition:width .6s ease}
    .option-btn{transition:.25s;border:2px solid transparent}
    .option-btn:hover{border-color:#8b5cf6;background:rgba(139,92,246,.08)}
    .option-btn.selected{background:linear-gradient(135deg,#8b5cf6,#3b82f6);color:#fff;border-color:#8b5cf6}
    .logo-img{height:56px;width:auto;object-fit:contain}
    .rtl{direction:rtl}
    .ltr{direction:ltr}
  </style>
</head>
<body class="p-4">
<div class="max-w-6xl mx-auto">

  <!-- Header -->
  <header class="glass rounded-3xl p-5 mb-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <!-- ثابت: شعار المدرسة -->
      <img id="school-logo" class="logo-img" alt="School Logo" src="" />
      <div>
        <h1 id="app-title" class="text-2xl font-extrabold text-gray-900">استبيان أنماط التعلم</h1>
        <p id="app-subtitle" class="text-sm text-gray-600">Learning Styles Assessment</p>
      </div>
    </div>
    <button id="lang-btn" class="btn bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold">🌐 English</button>
  </header>

  <!-- Info -->
  <section id="info-card" class="glass rounded-3xl p-8 mb-6">
    <h2 id="intro-title" class="text-xl font-extrabold text-gray-900 mb-2">ابدأ بتعبئة بياناتك</h2>
    <p id="intro-desc" class="text-gray-700 mb-6">اكتب اسمك وصفّك ثم ابدأ الاستبيان (15 سؤالًا)</p>
    <div class="grid sm:grid-cols-2 gap-4">
      <input id="student-name" type="text" class="w-full p-3 rounded-xl border focus:ring-2 focus:ring-purple-500" placeholder="اسم الطالب / Student Name" />
      <input id="student-class" type="text" class="w-full p-3 rounded-xl border focus:ring-2 focus:ring-purple-500" placeholder="الصف / Grade/Class" />
    </div>
    <button id="start-btn" class="btn mt-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-2xl font-extrabold">🚀 ابدأ / Start</button>
  </section>

  <!-- Progress -->
  <section id="progress-card" class="glass rounded-3xl p-6 mb-6 hidden">
    <div class="flex items-center justify-between mb-3">
      <span id="progress-label" class="font-bold text-gray-900">التقدم</span>
      <span id="progress-text" class="font-extrabold text-gray-800">0 / 15</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-3">
      <div id="progress-bar" class="bar bg-gradient-to-r from-indigo-500 to-purple-600 h-3 rounded-full" style="width:0%"></div>
    </div>
  </section>

  <!-- Quiz -->
  <section id="quiz-card" class="glass rounded-3xl p-8 hidden">
    <div class="text-center mb-8">
      <h3 id="question-title" class="text-xl font-extrabold text-gray-900 mb-4"></h3>
      <p id="question-text" class="text-gray-700 text-lg"></p>
    </div>
    <div id="options-container" class="space-y-3"></div>
    <div class="flex justify-between mt-8">
      <button id="prev-btn" class="btn bg-gray-500 text-white px-6 py-3 rounded-xl font-bold disabled:opacity-50" disabled>السابق</button>
      <button id="next-btn" class="btn bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl font-bold disabled:opacity-50" disabled>التالي</button>
    </div>
  </section>

  <!-- Results -->
  <section id="results-card" class="glass rounded-3xl p-8 hidden">
    <div class="text-center mb-6">
      <div id="result-emoji" class="text-6xl mb-2">🎯</div>
      <h3 id="result-title" class="text-2xl font-extrabold text-gray-900 mb-1">نمط التعلم الخاص بك</h3>
      <p id="result-style" class="text-xl font-bold text-gray-800"></p>
      <p id="result-desc" class="text-gray-700 mt-3 max-w-3xl mx-auto"></p>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <div class="rounded-2xl p-5 bg-white/70 border">
        <h4 id="details-title" class="font-extrabold text-gray-900 mb-4">النتائج التفصيلية</h4>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <span class="font-bold text-gray-700">👁️ بصري (Visual)</span>
            <div class="flex items-center gap-2">
              <div class="w-32 bg-gray-200 rounded-full h-3">
                <div id="visual-bar" class="bg-blue-500 h-3 rounded-full bar" style="width:0%"></div>
              </div>
              <span id="visual-score" class="font-bold text-gray-800 w-12 text-right">0%</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <span class="font-bold text-gray-700">👂 سمعي (Auditory)</span>
            <div class="flex items-center gap-2">
              <div class="w-32 bg-gray-200 rounded-full h-3">
                <div id="auditory-bar" class="bg-green-500 h-3 rounded-full bar" style="width:0%"></div>
              </div>
              <span id="auditory-score" class="font-bold text-gray-800 w-12 text-right">0%</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <span class="font-bold text-gray-700">🤲 حركي (Kinesthetic)</span>
            <div class="flex items-center gap-2">
              <div class="w-32 bg-gray-200 rounded-full h-3">
                <div id="kinesthetic-bar" class="bg-purple-500 h-3 rounded-full bar" style="width:0%"></div>
              </div>
              <span id="kinesthetic-score" class="font-bold text-gray-800 w-12 text-right">0%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="rounded-2xl p-5 bg-white/70 border">
        <h4 id="tips-title" class="font-extrabold text-gray-900 mb-4">نصائح للتعلم</h4>
        <div id="learning-tips" class="space-y-2 text-gray-700"></div>
      </div>
    </div>

    <div class="flex flex-wrap justify-center gap-3 mt-8">
      <button id="download-html"  class="btn bg-red-600 text-white px-6 py-3 rounded-xl font-bold">📄 تنزيل تقرير HTML</button>
      <button id="download-csv"   class="btn bg-green-600 text-white px-6 py-3 rounded-xl font-bold">📊 تنزيل ملف CSV</button>
      <button id="restart-btn"    class="btn bg-gray-600 text-white px-6 py-3 rounded-xl font-bold">🔄 إعادة البدء</button>
    </div>
  </section>

</div>

<script>
/* ===================== Config ===================== */
const LOGO_RELATIVE_PATH = "adis-logo.png"; // ضع ملف الشعار بجانب هذا الملف بهذا الاسم
let LOGO_DATA_URL = ""; // سنملؤه تلقائيًا من الملف أعلاه لدمجه داخل تقرير HTML

/* ===================== Language Text ===================== */
const content = {
  ar: {
    appTitle:"استبيان أنماط التعلم",
    appSubtitle:"Learning Styles Assessment",
    langBtn:"🌐 English",
    introTitle:"ابدأ بتعبئة بياناتك",
    introDesc:"اكتب اسمك وصفّك ثم ابدأ الاستبيان (15 سؤالًا)",
    startBtn:"🚀 ابدأ / Start",
    progressLabel:"التقدم",
    prevBtn:"السابق",
    nextBtn:"التالي",
    finishBtn:"إنهاء",
    resultTitle:"نمط التعلم الخاص بك",
    detailsTitle:"النتائج التفصيلية",
    tipsTitle:"نصائح للتعلم",
    downloadHtml:"📄 تنزيل تقرير HTML",
    downloadCsv:"📊 تنزيل ملف CSV",
    restartBtn:"🔄 إعادة البدء",
    student:"الطالب",
    klass:"الصف",
    date:"التاريخ",
    mainResult:"النتيجة الرئيسية",
    detailedResults:"النتائج التفصيلية",
    tips:"نصائح التعلم",
    vis:"بصري",
    aud:"سمعي",
    kin:"حركي",
  },
  en: {
    appTitle:"Learning Styles Assessment",
    appSubtitle:"استبيان أنماط التعلم",
    langBtn:"🌐 العربية",
    introTitle:"Start by filling your information",
    introDesc:"Enter your name and class then start the assessment (15 questions)",
    startBtn:"🚀 Start / ابدأ",
    progressLabel:"Progress",
    prevBtn:"Previous",
    nextBtn:"Next",
    finishBtn:"Finish",
    resultTitle:"Your Learning Style",
    detailsTitle:"Detailed Results",
    tipsTitle:"Learning Tips",
    downloadHtml:"📄 Download HTML Report",
    downloadCsv:"📊 Download CSV",
    restartBtn:"🔄 Restart",
    student:"Student",
    klass:"Class",
    date:"Date",
    mainResult:"Main Result",
    detailedResults:"Detailed Results",
    tips:"Learning Tips",
    vis:"Visual",
    aud:"Auditory",
    kin:"Kinesthetic",
  }
};

/* ===================== Questions (15) ===================== */
const questions = [
  { ar:"عندما أتعلم شيئًا جديدًا، أفضل أن:", en:"When I learn something new, I prefer to:",
    options:{ ar:["أرى الصور والرسوم البيانية والخرائط الذهنية","أستمع للشرح والمناقشات الصوتية","أجرب بنفسي وأطبق عمليًا"],
              en:["See pictures, diagrams, and mind maps","Listen to explanations and audio discussions","Try it myself and apply practically"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"عند حل المشاكل، أميل إلى:", en:"When solving problems, I tend to:",
    options:{ ar:["رسم المشكلة أو كتابتها بصريًا","التحدث عنها مع الآخرين ومناقشتها","التجريب والممارسة العملية المباشرة"],
              en:["Draw or write the problem visually","Talk about it with others and discuss","Experiment and practice directly"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"أتذكر المعلومات بشكل أفضل عندما:", en:"I remember information better when:",
    options:{ ar:["أراها مكتوبة أو في صور ملونة","أسمعها أو أكررها بصوت عالٍ","أكتبها بيدي أو أمارسها جسديًا"],
              en:["I see it written or in colorful images","I hear it or repeat it aloud","I write it by hand or practice it physically"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"في الفصل الدراسي، أركز بشكل أفضل عندما:", en:"In the classroom, I focus better when:",
    options:{ ar:["أرى العروض التقديمية والصور التوضيحية","أستمع للمحاضرة والمناقشات الجماعية","أشارك في الأنشطة العملية والتفاعلية"],
              en:["I see presentations and illustrative images","I listen to lectures and group discussions","I participate in hands-on and interactive activities"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"عند قراءة كتاب أو مقال، أفضل:", en:"When reading a book or article, I prefer:",
    options:{ ar:["الكتب المصورة مع الرسوم البيانية والجداول","الكتب الصوتية أو القراءة بصوت عالٍ","الكتب التفاعلية مع التمارين العملية"],
              en:["Illustrated books with diagrams and tables","Audio books or reading aloud","Interactive books with practical exercises"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"أفهم التعليمات والإرشادات بشكل أفضل عندما تكون:", en:"I understand instructions and directions better when they are:",
    options:{ ar:["مكتوبة أو مرسومة بوضوح مع الأمثلة","مشروحة شفهيًا بالتفصيل","موضحة بالتطبيق العملي والتجريب"],
              en:["Written or drawn clearly with examples","Explained verbally in detail","Demonstrated through practical application"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"عندما أدرس للامتحانات، أفضل:", en:"When studying for exams, I prefer:",
    options:{ ar:["استخدام الخرائط الذهنية والملاحظات الملونة","مراجعة المادة بصوت عالٍ أو مع الأصدقاء","كتابة الملاحظات وحل التمارين بالقلم"],
              en:["Using mind maps and colored notes","Reviewing material aloud or with friends","Writing notes and solving exercises with pen"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"أتعلم الرياضيات والعلوم بشكل أفضل من خلال:", en:"I learn math and science better through:",
    options:{ ar:["الرسوم البيانية والجداول والمخططات","الشرح الشفهي المفصل للخطوات","حل المسائل بالممارسة والتجريب"],
              en:["Graphs, tables, and charts","Detailed verbal explanation of steps","Solving problems through practice and experimentation"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"في العمل الجماعي، أساهم بشكل أفضل عندما:", en:"In group work, I contribute better when:",
    options:{ ar:["أرسم أو أعرض الأفكار بصريًا على السبورة","أناقش وأتحدث عن الأفكار مع الفريق","أعمل على المشاريع العملية بيدي"],
              en:["I draw or present ideas visually on the board","I discuss and talk about ideas with the team","I work on practical projects with my hands"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"أحب الأنشطة التعليمية التي تتضمن:", en:"I enjoy educational activities that involve:",
    options:{ ar:["المشاهدة والملاحظة والتحليل البصري","الاستماع والمناقشة والحوار","الحركة والتطبيق العملي والتجريب"],
              en:["Watching, observing, and visual analysis","Listening, discussion, and dialogue","Movement, practical application, and experimentation"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"عند تعلم لغة جديدة، أفضل:", en:"When learning a new language, I prefer:",
    options:{ ar:["رؤية الكلمات مكتوبة مع الصور التوضيحية","سماع النطق الصحيح والمحادثات الصوتية","ممارسة المحادثة والكتابة بالقلم"],
              en:["Seeing words written with illustrative images","Hearing correct pronunciation and audio conversations","Practicing conversation and writing with pen"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"أفضل المعلمين والمدربين الذين:", en:"I prefer teachers and trainers who:",
    options:{ ar:["يستخدمون العروض التقديمية والوسائل البصرية","يشرحون بوضوح ويشجعون المناقشة","يطبقون الدروس عمليًا ويشركون الطلاب"],
              en:["Use presentations and visual aids","Explain clearly and encourage discussion","Apply lessons practically and engage students"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"عندما أحتاج لتذكر معلومة مهمة:", en:"When I need to remember important information:",
    options:{ ar:["أكتبها أو أرسمها أو أتخيلها بصريًا","أكررها بصوت عالٍ أو أناقشها مع آخرين","أكتبها عدة مرات أو أربطها بحركة معينة"],
              en:["I write, draw, or visualize it","I repeat it aloud or discuss it with others","I write it several times or associate it with movement"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"أستمتع بالتعلم من خلال:", en:"I enjoy learning through:",
    options:{ ar:["الأفلام التعليمية والصور والرسوم المتحركة","البودكاست والمحاضرات الصوتية والموسيقى","التجارب والأنشطة العملية والرحلات الميدانية"],
              en:["Educational videos, images, and animations","Podcasts, audio lectures, and music","Experiments, practical activities, and field trips"]},
    type:["visual","auditory","kinesthetic"] },
  { ar:"عند التفكير في حل مسألة معقدة، أميل إلى:", en:"When thinking about solving a complex problem, I tend to:",
    options:{ ar:["تصور الأفكار في ذهني ورسم المخططات","التحدث مع نفسي أو مناقشة الأمر مع الآخرين","الحركة أو استخدام يدي أو الكتابة أثناء التفكير"],
              en:["Visualize ideas in my mind and draw diagrams","Talk to myself or discuss with others","Move, use my hands, or write while thinking"]},
    type:["visual","auditory","kinesthetic"] }
];

/* ===================== Learning Styles ===================== */
const learningStyles = {
  visual: {
    ar:{name:"المتعلم البصري", emoji:"👁️",
      desc:"تتعلم بشكل أفضل من خلال الرؤية والصور والرسوم البيانية. تفضل المعلومات المرئية والألوان والتنظيم البصري.",
      tips:["استخدم الخرائط الذهنية والرسوم البيانية","اكتب الملاحظات بألوان مختلفة","شاهد الفيديوهات التعليمية","استخدم الصور والرموز في المراجعة","نظم مساحة الدراسة بصريًا"]},
    en:{name:"Visual Learner", emoji:"👁️",
      desc:"You learn best through seeing, images, and diagrams. You prefer visual information, colors, and visual organization.",
      tips:["Use mind maps and diagrams","Write notes in different colors","Watch educational videos","Use images and symbols in review","Organize study space visually"]}
  },
  auditory: {
    ar:{name:"المتعلم السمعي", emoji:"👂",
      desc:"تتعلم بشكل أفضل من خلال الاستماع والمناقشة والأصوات. تفضل الشرح الشفهي والمحادثات التعليمية.",
      tips:["اقرأ المادة بصوت عالٍ","ناقش المواضيع مع الآخرين","استمع للمحاضرات الصوتية","استخدم التكرار الشفهي","ادرس في مجموعات للمناقشة"]},
    en:{name:"Auditory Learner", emoji:"👂",
      desc:"You learn best through listening, discussion, and sounds. You prefer verbal explanations and educational conversations.",
      tips:["Read material aloud","Discuss topics with others","Listen to audio lectures","Use verbal repetition","Study in groups for discussion"]}
  },
  kinesthetic: {
    ar:{name:"المتعلم الحركي", emoji:"🤲",
      desc:"تتعلم بشكل أفضل من خلال الممارسة والحركة والتطبيق العملي. تفضل التعلم بالتجربة واللمس.",
      tips:["اكتب الملاحظات بيدك","استخدم النماذج والمواد الملموسة","خذ فترات راحة للحركة","طبق ما تتعلمه عمليًا","استخدم الإيماءات أثناء الدراسة"]},
    en:{name:"Kinesthetic Learner", emoji:"🤲",
      desc:"You learn best through practice, movement, and hands-on application. You prefer learning by experience and touch.",
      tips:["Write notes by hand","Use models and tangible materials","Take movement breaks","Apply what you learn practically","Use gestures while studying"]}
  }
};

/* ===================== State ===================== */
let currentLang='ar';
let currentQuestion=0;
let answers=[];
let studentName='', studentClass='';

/* ===================== DOM refs ===================== */
const el = {
  langBtn:document.getElementById('lang-btn'),
  logo:document.getElementById('school-logo'),
  appTitle:document.getElementById('app-title'),
  appSubtitle:document.getElementById('app-subtitle'),
  infoCard:document.getElementById('info-card'),
  progressCard:document.getElementById('progress-card'),
  quizCard:document.getElementById('quiz-card'),
  resultsCard:document.getElementById('results-card'),
  startBtn:document.getElementById('start-btn'),
  studentName:document.getElementById('student-name'),
  studentClass:document.getElementById('student-class'),
  progressLabel:document.getElementById('progress-label'),
  progressText:document.getElementById('progress-text'),
  progressBar:document.getElementById('progress-bar'),
  questionTitle:document.getElementById('question-title'),
  questionText:document.getElementById('question-text'),
  options:document.getElementById('options-container'),
  prevBtn:document.getElementById('prev-btn'),
  nextBtn:document.getElementById('next-btn'),
  resultEmoji:document.getElementById('result-emoji'),
  resultTitle:document.getElementById('result-title'),
  resultStyle:document.getElementById('result-style'),
  resultDesc:document.getElementById('result-desc'),
  visualBar:document.getElementById('visual-bar'),
  auditoryBar:document.getElementById('auditory-bar'),
  kinestheticBar:document.getElementById('kinesthetic-bar'),
  visualScore:document.getElementById('visual-score'),
  auditoryScore:document.getElementById('auditory-score'),
  kinestheticScore:document.getElementById('kinesthetic-score'),
  learningTips:document.getElementById('learning-tips'),
  downloadHTML:document.getElementById('download-html'),
  downloadCSV:document.getElementById('download-csv'),
  restartBtn:document.getElementById('restart-btn'),
  introTitle:document.getElementById('intro-title'),
  introDesc:document.getElementById('intro-desc'),
  detailsTitle:document.getElementById('details-title'),
  tipsTitle:document.getElementById('tips-title'),
};

/* ===================== Init ===================== */
document.addEventListener('DOMContentLoaded', async () => {
  await loadLogoDataURL();   // جهّز الشعار (ويُعرض فورًا ويُدمج في HTML المُحمّل)
  bindEvents();
  updateLanguage();
});

/* ===================== Logo Loader ===================== */
async function loadLogoDataURL(){
  try{
    const resp = await fetch(LOGO_RELATIVE_PATH, {cache:'no-store'});
    if(!resp.ok) throw new Error('Logo not found');
    const blob = await resp.blob();
    LOGO_DATA_URL = await blobToDataURL(blob);
    el.logo.src = LOGO_DATA_URL;
  }catch(e){
    // شعار بديل نصّي لو لم يوجد الملف
    el.logo.remove(); // لا نظهر صورة تالفة
    const fallback = document.createElement('div');
    fallback.className = "h-14 px-4 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-lg shadow flex items-center justify-center";
    fallback.innerHTML = '<span class="text-white font-extrabold text-lg">ADIS</span>';
    document.querySelector('header .flex.items-center').prepend(fallback);
  }
}
function blobToDataURL(blob){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(blob);
  });
}

/* ===================== Events ===================== */
function bindEvents(){
  el.langBtn.addEventListener('click', toggleLanguage);
  el.startBtn.addEventListener('click', startQuiz);
  el.prevBtn.addEventListener('click', prevQuestion);
  el.nextBtn.addEventListener('click', nextQuestion);
  el.downloadHTML.addEventListener('click', downloadHTMLReport);
  el.downloadCSV.addEventListener('click', downloadCSV);
  el.restartBtn.addEventListener('click', restart);
}

/* ===================== Language ===================== */
function toggleLanguage(){
  currentLang = currentLang==='ar' ? 'en' : 'ar';
  updateLanguage();
  if(currentQuestion>=0 && !el.infoCard.classList.contains('hidden')){
    // فقط واجهة البداية
  }else if(!el.quizCard.classList.contains('hidden')){
    displayQuestion();
  }
}
function updateLanguage(){
  const t = content[currentLang];
  document.documentElement.lang = currentLang;
  document.documentElement.dir  = currentLang==='ar' ? 'rtl':'ltr';

  el.appTitle.textContent = t.appTitle;
  el.appSubtitle.textContent = t.appSubtitle;
  el.langBtn.textContent = t.langBtn;
  el.introTitle.textContent = t.introTitle;
  el.introDesc.textContent = t.introDesc;
  el.startBtn.textContent = t.startBtn;
  el.progressLabel.textContent = t.progressLabel;
  el.prevBtn.textContent = t.prevBtn;
  el.nextBtn.textContent = t.nextBtn;
  el.resultTitle.textContent = t.resultTitle;
  el.detailsTitle.textContent = t.detailsTitle;
  el.tipsTitle.textContent = t.tipsTitle;
  el.downloadHTML.textContent = t.downloadHtml;
  el.downloadCSV.textContent = t.downloadCsv;
  el.restartBtn.textContent = t.restartBtn;
}

/* ===================== Quiz Flow ===================== */
function startQuiz(){
  studentName = el.studentName.value.trim();
  studentClass = el.studentClass.value.trim();
  if(!studentName || !studentClass){
    alert(currentLang==='ar' ? 'يرجى إدخال الاسم والصف' : 'Please enter name and class');
    return;
  }
  currentQuestion = 0;
  answers = [];
  el.infoCard.classList.add('hidden');
  el.progressCard.classList.remove('hidden');
  el.quizCard.classList.remove('hidden');
  displayQuestion();
  updateProgress();
}

function displayQuestion(){
  const q = questions[currentQuestion];
  const qNum = currentQuestion+1;

  el.questionTitle.textContent = (currentLang==='ar' ? 'السؤال' : 'Question') + ' ' + qNum + ' / ' + questions.length;
  el.questionText.textContent = q[currentLang];
  el.options.innerHTML = '';

  q.options[currentLang].forEach((opt, idx)=>{
    const btn = document.createElement('button');
    btn.className = 'option-btn w-full p-4 text-right rounded-xl bg-white border-2 border-gray-200';
    btn.textContent = opt;
    btn.addEventListener('click', (ev)=> selectOption(idx, ev.currentTarget));
    if(answers[currentQuestion] === idx){
      btn.classList.add('selected');
    }
    el.options.appendChild(btn);
  });

  el.prevBtn.disabled = currentQuestion===0;
  el.nextBtn.disabled = answers[currentQuestion]===undefined;
  el.nextBtn.textContent = currentQuestion===questions.length-1
    ? (currentLang==='ar' ? 'إنهاء' : 'Finish')
    : (currentLang==='ar' ? 'التالي' : 'Next');
}

function selectOption(index, buttonEl){
  // clear previous selection
  [...el.options.querySelectorAll('.option-btn')].forEach(b=>b.classList.remove('selected'));
  buttonEl.classList.add('selected');
  answers[currentQuestion] = index;
  el.nextBtn.disabled = false;
}

function prevQuestion(){
  if(currentQuestion>0){
    currentQuestion--;
    displayQuestion();
    updateProgress();
  }
}
function nextQuestion(){
  if(answers[currentQuestion]===undefined) return;
  if(currentQuestion < questions.length-1){
    currentQuestion++;
    displayQuestion();
    updateProgress();
  }else{
    showResults();
  }
}
function updateProgress(){
  const progress = ((currentQuestion+1)/questions.length)*100;
  el.progressText.textContent = `${currentQuestion+1} / ${questions.length}`;
  el.progressBar.style.width = progress + '%';
}

/* ===================== Results ===================== */
function showResults(){
  const scores = {visual:0,auditory:0,kinesthetic:0};
  answers.forEach((ans, i)=>{ scores[questions[i].type[ans]]++; });

  const total = questions.length;
  const pct = {
    visual: Math.round(scores.visual/total*100),
    auditory: Math.round(scores.auditory/total*100),
    kinesthetic: Math.round(scores.kinesthetic/total*100),
  };

  const dominant = Object.keys(scores).reduce((a,b)=> scores[a]>=scores[b]?a:b);
  const info = learningStyles[dominant][currentLang];

  el.resultEmoji.textContent = info.emoji;
  el.resultStyle.textContent = info.name;
  el.resultDesc.textContent = info.desc;

  el.visualBar.style.width = pct.visual+'%';
  el.auditoryBar.style.width = pct.auditory+'%';
  el.kinestheticBar.style.width = pct.kinesthetic+'%';

  el.visualScore.textContent = pct.visual+'%';
  el.auditoryScore.textContent = pct.auditory+'%';
  el.kinestheticScore.textContent = pct.kinesthetic+'%';

  el.learningTips.innerHTML='';
  info.tips.forEach((tip,i)=>{
    const row = document.createElement('div');
    row.className='flex items-start gap-2';
    row.innerHTML = `<span class="text-purple-600 font-bold">•</span><span>${tip}</span>`;
    el.learningTips.appendChild(row);
  });

  el.quizCard.classList.add('hidden');
  el.progressCard.classList.add('hidden');
  el.resultsCard.classList.remove('hidden');

  window.currentResults = {
    lang: currentLang,
    studentName,
    studentClass,
    date: new Date().toLocaleDateString(currentLang==='ar'?'ar-SA':'en-US'),
    dominantKey: dominant,
    styleName: info.name,
    styleEmoji: info.emoji,
    styleDesc: info.desc,
    tips: info.tips,
    scores: pct
  };
}

/* ===================== Export: HTML ===================== */
function downloadHTMLReport(){
  const res = window.currentResults;
  if(!res){
    alert(currentLang==='ar' ? 'يرجى إكمال الاستبيان أولاً' : 'Please complete the assessment first');
    return;
  }
  const t = content[res.lang];
  const isAr = res.lang==='ar';
  const dir = isAr?'rtl':'ltr';
  const title = isAr ? 'تقرير أنماط التعلم' : 'Learning Styles Report';
  const fileBase = 'ADIS-Report-' + new Date().toISOString().slice(0,10);

  const logoImgHTML = LOGO_DATA_URL
    ? `<img alt="School Logo" src="${LOGO_DATA_URL}" style="height:56px;object-fit:contain;"/>`
    : `<div style="height:56px;padding:0 14px;background:#6d28d9;color:#fff;display:inline-flex;align-items:center;border-radius:10px;font-weight:800">ADIS</div>`;

  const html = `<!DOCTYPE html>
<html lang="${res.lang}" dir="${dir}">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>${title}</title>
<style>
  body{font-family:'Cairo',Arial,sans-serif;background:#f4f6fb;margin:0;padding:24px;color:#111}
  .card{max-width:900px;margin:0 auto;background:#fff;border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.08);overflow:hidden}
  .header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  .header h1{margin:0;font-size:20px}
  .section{padding:24px}
  .tag{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;padding:4px 10px;border-radius:999px;font-weight:700}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .row{display:flex;justify-content:space-between;margin:8px 0;padding:10px 12px;background:#f8fafc;border-radius:10px}
  .bar{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
  .fill{height:100%}
  .fill.v{background:linear-gradient(90deg,#60a5fa,#f59e0b)}
  .fill.a{background:linear-gradient(90deg,#34d399,#059669)}
  .fill.k{background:linear-gradient(90deg,#8b5cf6,#3b82f6)}
  ul{margin:0;padding-${isAr?'right':'left'}:22px}
  li{margin:8px 0}
</style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div style="display:flex;align-items:center;gap:12px">${logoImgHTML}
        <div>
          <div style="font-size:18px;font-weight:800">ADIS</div>
          <div style="opacity:.9">${t.appTitle}</div>
        </div>
      </div>
      <span class="tag">${isAr?'تقرير إلكتروني':'Digital Report'}</span>
    </div>

    <div class="section">
      <h2 style="margin:0 0 10px 0">${isAr?'معلومات الطالب':'Student Information'}</h2>
      <div class="grid">
        <div class="row"><strong>${t.student}</strong><span>${res.studentName}</span></div>
        <div class="row"><strong>${t.klass}</strong><span>${res.studentClass}</span></div>
        <div class="row"><strong>${t.date}</strong><span>${res.date}</span></div>
        <div class="row"><strong>${isAr?'المدرسة':'School'}</strong><span>ADIS</span></div>
      </div>
    </div>

    <div class="section">
      <h2 style="margin:0 0 12px 0">${t.mainResult}</h2>
      <div style="padding:18px;border:2px solid #e5e7eb;border-radius:12px">
        <div style="font-size:22px;font-weight:800;margin-bottom:8px">${res.styleEmoji} ${res.styleName}</div>
        <div style="opacity:.9;line-height:1.9">${res.styleDesc}</div>
      </div>
    </div>

    <div class="section">
      <h2 style="margin:0 0 12px 0">${t.detailedResults}</h2>
      <div class="row"><span>👁️ ${t.vis}</span><span>${res.scores.visual}%</span></div>
      <div class="bar"><div class="fill v" style="width:${res.scores.visual}%"></div></div>
      <div class="row" style="margin-top:12px"><span>👂 ${t.aud}</span><span>${res.scores.auditory}%</span></div>
      <div class="bar"><div class="fill a" style="width:${res.scores.auditory}%"></div></div>
      <div class="row" style="margin-top:12px"><span>🤲 ${t.kin}</span><span>${res.scores.kinesthetic}%</span></div>
      <div class="bar"><div class="fill k" style="width:${res.scores.kinesthetic}%"></div></div>
    </div>

    <div class="section">
      <h2 style="margin:0 0 12px 0">${t.tips}</h2>
      <ul>${res.tips.map(tip=>`<li>${tip}</li>`).join('')}</ul>
    </div>
  </div>
</body>
</html>`;

  const blob = new Blob([html],{type:'text/html;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileBase + (isAr?'-AR': '-EN') + '.html';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},100);
}

/* ===================== Export: CSV (Excel) ===================== */
function downloadCSV(){
  const res = window.currentResults;
  if(!res){
    alert(currentLang==='ar' ? 'يرجى إكمال الاستبيان أولاً' : 'Please complete the assessment first');
    return;
  }
  const t = content[res.lang];
  const lines = [];
  lines.push(res.lang==='ar' ? 'تقرير ADIS' : 'ADIS Report');
  lines.push('');
  lines.push(`${t.student},${csvEscape(res.studentName)}`);
  lines.push(`${t.klass},${csvEscape(res.studentClass)}`);
  lines.push(`${t.date},${csvEscape(res.date)}`);
  lines.push(`School,ADIS`);
  lines.push('');
  lines.push(`${res.lang==='ar'?'نمط التعلم': 'Learning Style'},${csvEscape(res.styleName)}`);
  lines.push('');
  lines.push(res.lang==='ar' ? 'النتائج' : 'Results');
  lines.push(`${t.vis},${res.scores.visual}%`);
  lines.push(`${t.aud},${res.scores.auditory}%`);
  lines.push(`${t.kin},${res.scores.kinesthetic}%`);
  lines.push('');
  lines.push(res.lang==='ar' ? 'نصائح' : 'Tips');
  res.tips.forEach((tip,i)=> lines.push(`${i+1},${csvEscape(tip)}`));

  const csv = '\uFEFF' + lines.join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ADIS-Data-' + new Date().toISOString().slice(0,10) + (res.lang==='ar'?'-AR': '-EN') + '.csv';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },100);
}
function csvEscape(s){ return `"${String(s).replace(/"/g,'""')}"`; }

/* ===================== Restart ===================== */
function restart(){
  currentQuestion=0;
  answers=[];
  studentName='';
  studentClass='';
  el.studentName.value='';
  el.studentClass.value='';
  el.resultsCard.classList.add('hidden');
  el.progressCard.classList.add('hidden');
  el.quizCard.classList.add('hidden');
  el.infoCard.classList.remove('hidden');
}
</script>
</body>
</html>
